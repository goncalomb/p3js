module.exports = function(p3js) {

	eval(p3js.extractConstants());

	var simulator = p3js.Simulator = function() {
		if (!(this instanceof simulator)) {
			return new simulator();
		}
		this._memory = new ArrayBuffer(MEMORY_SIZE * MEMORY_WORD_SIZE);
		this._romA = this._romB = this._romC = null;
		this.resetRomA();
		this.resetRomB();
		this.resetRomC();
		this._registers = [      // R0    = 0
			0, 0, 0, 0, 0, 0, 0, // R1-7  general use
			0, 0, 0,             // R8-10 restricted use
			0,                   // R11   = SD (source data)
			0,                   // R12   = EA (effective address)
			0,                   // R13   = RD (result data)
			0,                   // R14   = SP (stack pointer)
			0                    // R15   = PC (program counter)
		];
		this._ri = 0;            // RI    (instruction register)
		this._re = 0;            // RE    (status register)
		this._car = 0;           // CAR   (control address register)
		this._sbr = 0;           // SBR   (subroutine branch register)
	};

	simulator.prototype.resetRomA = function() {
		this._romA = [
			0x0032, 0x0033, 0x0037, 0x003b, 0x003e, 0x0040, 0x0044, 0x0047,
			0x004c, 0x0055,      0,      0,      0,      0,      0,      0,
			0x005b, 0x005e, 0x0060, 0x0062, 0x0064, 0x0067,      0,      0,
			0x006a, 0x0071, 0x0078, 0x007f, 0x008c, 0x0093, 0x009a, 0x00a1,
			0x00c2, 0x00b4, 0x00b6, 0x00b8, 0x00ba, 0x00cf, 0x00dd, 0x00c4,
			0x00bc, 0x00be, 0x00c0, 0x00a8, 0x00af, 0x00aa, 0x00ca,      0,
			0x0102, 0x0105, 0x0109, 0x010d,      0,      0,      0,      0,
			0x00f9, 0x00f8,      0,      0,      0,      0,      0,      0
			// empty addresses: 10 to 15, 22, 23, 47, 52 to 55, 58 to 63
		];
	};

	simulator.prototype.resetRomB = function() {
		this._romB = [
			0x000a, 0x000b, 0x000d, 0x000f, 0x002d, 0x002f, 0x002d, 0x002f,
			0x0013, 0x0017, 0x001d, 0x0023, 0x0015, 0x001a, 0x0020, 0x0028
		];
	};

	simulator.prototype.resetRomC = function() {
		this._romC = [
			0x8060001f, 0x400a009f, 0x81c000d8, 0x0008319e,
			0x04083f9e, 0x000000b9, 0x804200f8, 0x00023099,
			0x000132bf, 0x80100010, 0x2031009d, 0x0031009c,
			0x200138bd, 0x00013ebd, 0x200a009f, 0x00013ebc,
			0x000a009f, 0x0000009c, 0x200138bd, 0x0031009d,
			0x2031409b, 0x0031009b, 0x2031409d, 0x0031009c,
			0x000138bd, 0x2031409b, 0x0031009c, 0x000138bb,
			0x2031409d, 0x00013ebd, 0x000a009f, 0x2031409b,
			0x00013ebb, 0x000a009f, 0x2031409d, 0x00013ebc,
			0x000a009f, 0x0000009c, 0x000138bd, 0x2031409b,
			0x00013ebc, 0x000a009f, 0x0000009c, 0x000138bb,
			0x2031409d, 0x00313a80, 0x80000200, 0x83002d00,
			0x00003b1c, 0x80000200, 0x80000200, 0x804010f8,
			0x000000d9, 0x00143298, 0x80100218, 0x80400ff8,
			0x000000d9, 0x00123298, 0x80100218, 0x00112098,
			0x010a0018, 0x80000200, 0x01002010, 0x80000200,
			0x804004f8, 0x000000d9, 0x00163298, 0x80100218,
			0x000a009e, 0x00013cbf, 0x80000200, 0x000a009e,
			0x00013cbf, 0x000a009e, 0x00013cb8, 0x80100218,
			0x000000d8, 0x0008319e, 0x00083f9e, 0x8040fff8,
			0x00128098, 0x804200f9, 0x00023298, 0x000130bf,
			0x80100010, 0x000a009e, 0x00013cbf, 0x8043fff8,
			0x00128098, 0x0000309e, 0x80000200, 0xe40000f8,
			0x03c23a98, 0x7031309d, 0xe4000000, 0x73ca009d,
			0xe4000000, 0x73c8009d, 0xe4000000, 0x7290009d,
			0xe4000000, 0x00083b9e, 0x80000200, 0xe4000000,
			0x000a009e, 0x70013cbd, 0xe403c0f8, 0x00128098,
			0x804040f9, 0x03a0009d, 0x00023298, 0x80c06d00,
			0x70000000, 0xe403c0f8, 0x00128098, 0x804040f9,
			0x03a2009d, 0x00023298, 0x80c07400, 0x70000000,
			0xe403c0f8, 0x00128098, 0x804040f9, 0x03e4009d,
			0x00023298, 0x80c07b00, 0x70000000, 0xe403c0f8,
			0x00128098, 0x0031209a, 0x03e6009d, 0x000000d9,
			0x0014329a, 0x804040f9, 0x00023298, 0x80c082d9,
			0x804001f8, 0x0012309a, 0x0014329a, 0xf010001a,
			0xe403c0f8, 0x00128098, 0x804040f9, 0x03a8009d,
			0x00023298, 0x80c08f00, 0x70000000, 0xe403c0f8,
			0x00128098, 0x804040f9, 0x03aa009d, 0x00023298,
			0x80c09600, 0x70000000, 0xe403c0f8, 0x00128098,
			0x804040f9, 0x03ac009d, 0x00023298, 0x80c09d00,
			0x70000000, 0xe403c0f8, 0x00128098, 0x804040f9,
			0x03ae009d, 0x00023298, 0x80c0a400, 0x70000000,
			0xec000000, 0x7031369d, 0xec00fff8, 0x00113099,
			0x0012329d, 0x00123698, 0x7014309d, 0xec00fff8,
			0x00113099, 0x0012309d, 0x00123699, 0x7014329d,
			0xec000000, 0x73c0369d, 0xec000000, 0x73c4369d,
			0xec000000, 0x73c2369d, 0xec000000, 0x73c6369d,
			0xec000000, 0x7292369d, 0xec000000, 0x7294369d,
			0xec000000, 0x7296369d, 0xec000000, 0x73c2361d,
			0xec000000, 0x7292361d, 0x8340c900, 0x8240c900,
			0x7000371c, 0x70317680, 0xec000000, 0x00313a98,
			0x0031369d, 0x0031309b, 0x8000c600, 0xec0010f8,
			0x000000da, 0x0012309a, 0x00313a99, 0x01f1209d,
			0x002c009b, 0x8150d71a, 0x0100329d, 0x012c009d,
			0x00080098, 0x80c0d400, 0x012c009b, 0x0200361d,
			0x8000c600, 0xec0000d8, 0x0000201b, 0x80c0e300,
			0x804001f9, 0x00143298, 0x80100218, 0x01c12099,
			0x0002361d, 0x8140f500, 0x00312098, 0x000a0098,
			0x0122009b, 0x8100ec00, 0x0002361d, 0x8100e700,
			0x002c009b, 0x0102369d, 0x8100f100, 0x0000369d,
			0x01300010, 0x002e0099, 0x0020009b, 0x00080098,
			0x80c0ed00, 0x00313a9b, 0x0331329d, 0x8000c600,
			0x83c00200, 0x80403ff8, 0x0013b099, 0x804020fa,
			0x0012329a, 0x80810000, 0x00100098, 0x00143099,
			0x0000329f, 0x80000200, 0xe4000000, 0x00313a9f,
			0x80000200, 0xe4000000, 0x83c00200, 0x00313a9f,
			0x80000200, 0xe4000000, 0x00083f9e, 0x00313a9f,
			0x80000200, 0xe4000000, 0x83c00200, 0x00083f9e,
			0x00313a9f, 0x80000200,
			// empty from 274 to 511
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
		];
	};

};
